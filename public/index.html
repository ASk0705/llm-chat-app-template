<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LLM Chat App</title>

<style>
:root {
  --bg: #0b0f1a;
  --card: #12182b;
  --accent: #4cc9f0;
  --user: #4895ef;
  --ai: #560bad;
  --text: #e6e6eb;
  --text-light: #9ca3af;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", system-ui, sans-serif;
}

body {
  background: radial-gradient(circle at top, #141a3a, var(--bg));
  color: var(--text);
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

header {
  margin: 1rem 0;
  text-align: center;
}

h1 {
  font-size: 1.6rem;
  background: linear-gradient(135deg, var(--accent), #4895ef);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ===== Toggle Switch ===== */
.mode-toggle {
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
  font-size: 0.9rem;
}

.switch {
  position: relative;
  width: 54px;
  height: 28px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  background: #1f2a55;
  border-radius: 28px;
  inset: 0;
  transition: 0.3s;
}

.slider:before {
  content: "";
  position: absolute;
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background: var(--accent);
  border-radius: 50%;
  transition: 0.3s;
}

input:checked + .slider {
  background: #1f2a55;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

/* ===== Chat ===== */
.chat-container {
  width: 100%;
  max-width: 800px;
  height: calc(100vh - 190px);
  background: var(--card);
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 0 40px rgba(76, 201, 240, 0.15);
}

.chat-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message {
  max-width: 80%;
  padding: 12px 14px;
  border-radius: 14px;
  animation: fadeIn 0.3s ease-in;
}

.message p {
  margin: 0;
  white-space: pre-line;
  overflow-wrap: anywhere;
}

.user-message {
  align-self: flex-end;
  background: linear-gradient(135deg, var(--user), #4361ee);
}

.assistant-message {
  align-self: flex-start;
  background: linear-gradient(135deg, var(--ai), #7209b7);
}

.typing-indicator {
  display: none;
  padding: 0.5rem 1rem;
  font-style: italic;
  color: var(--text-light);
}

.typing-indicator.visible {
  display: block;
}

.message-input {
  display: flex;
  gap: 10px;
  padding: 12px;
  background: #0e1430;
  border-top: 1px solid #1f2a55;
}

#user-input {
  flex: 1;
  background: #0b1025;
  border: 1px solid #1f2a55;
  color: var(--text);
  padding: 12px;
  border-radius: 12px;
  resize: none;
  min-height: 44px;
}

#send-button {
  padding: 0 18px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  background: linear-gradient(135deg, var(--accent), #4895ef);
  color: #000;
}

#send-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

footer {
  margin: 0.75rem 0;
  font-size: 0.85rem;
  color: var(--text-light);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<header>
  <h1>ASK AI Chat</h1>
  <div class="mode-toggle">
    <span>HTTP</span>
    <label class="switch">
      <input type="checkbox" id="modeToggle" checked />
      <span class="slider"></span>
    </label>
    <span>SSE</span>
  </div>
</header>

<div class="chat-container">
  <div id="chat-messages" class="chat-messages">
    <div class="message assistant-message">
      <p>Hello! I'm an AskAI. How can I help you today?</p>
    </div>
  </div>

  <div class="typing-indicator" id="typing-indicator">
    AI is thinking...
  </div>

  <div class="message-input">
    <textarea id="user-input" placeholder="Type your message here..." rows="1"></textarea>
    <button id="send-button">Send</button>
  </div>
</div>

<footer>
  <p>ASK AI Chat Template &copy; 2025</p>
</footer>

<script>
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");
const typingIndicator = document.getElementById("typing-indicator");
const modeToggle = document.getElementById("modeToggle");

let isProcessing = false;
let chatHistory = [];

sendButton.onclick = sendMessage;

userInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function addMessage(role, text) {
  const div = document.createElement("div");
  div.className = `message ${role}-message`;
  div.innerHTML = `<p></p>`;
  div.querySelector("p").textContent = text;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div.querySelector("p");
}

async function fakeTyping(el, text) {
  el.textContent = "";
  for (const ch of text) {
    el.textContent += ch;
    await new Promise(r => setTimeout(r, 18));
  }
}

async function sendMessage() {
  const msg = userInput.value.trim();
  if (!msg || isProcessing) return;

  isProcessing = true;
  userInput.disabled = true;
  sendButton.disabled = true;

  addMessage("user", msg);
  chatHistory.push({ role: "user", content: msg });
  userInput.value = "";
  typingIndicator.classList.add("visible");

  const assistantEl = addMessage("assistant", "");

  try {
    const useSSE = modeToggle.checked;

    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: chatHistory })
    });

    if (!res.ok) throw new Error("API error");

    if (useSSE) {
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";
      let fullText = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const parsed = consumeSse(buffer);
        buffer = parsed.buffer;

        for (const ev of parsed.events) {
          if (ev === "[DONE]") break;
          const json = JSON.parse(ev);
          const chunk = json.response || json.choices?.[0]?.delta?.content || "";
          fullText += chunk;
          assistantEl.textContent = fullText;
        }
      }
      chatHistory.push({ role: "assistant", content: fullText });
    } else {
      const data = await res.json();
      const text = data.content || data.response || data.choices?.[0]?.message?.content || "";
      await fakeTyping(assistantEl, text);
      chatHistory.push({ role: "assistant", content: text });
    }

  } catch (e) {
    assistantEl.textContent = "Error processing request.";
  } finally {
    typingIndicator.classList.remove("visible");
    isProcessing = false;
    userInput.disabled = false;
    sendButton.disabled = false;
  }
}

function consumeSse(buffer) {
  buffer = buffer.replace(/\r/g, "");
  const events = [];
  let idx;
  while ((idx = buffer.indexOf("\n\n")) !== -1) {
    const raw = buffer.slice(0, idx);
    buffer = buffer.slice(idx + 2);
    const data = raw
      .split("\n")
      .filter(l => l.startsWith("data:"))
      .map(l => l.slice(5).trim())
      .join("\n");
    if (data) events.push(data);
  }
  return { events, buffer };
}
</script>

</body>
</html>
